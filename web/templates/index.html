<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div id="container-main">
        <div class="section">
            <div class="lil-container">
                <input id="input" class="gray input font-1" onkeyup="new_task_enter(event)">
                <div class="icon-container hover-white" onclick="new_task(true)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.5 8.96533C9.5 8.48805 9.5 8.24941 9.59974 8.11618C9.68666 8.00007 9.81971 7.92744 9.96438 7.9171C10.1304 7.90525 10.3311 8.03429 10.7326 8.29239L15.4532 11.3271C15.8016 11.551 15.9758 11.663 16.0359 11.8054C16.0885 11.9298 16.0885 12.0702 16.0359 12.1946C15.9758 12.337 15.8016 12.449 15.4532 12.6729L10.7326 15.7076C10.3311 15.9657 10.1304 16.0948 9.96438 16.0829C9.81971 16.0726 9.68666 15.9999 9.59974 15.8838C9.5 15.7506 9.5 15.512 9.5 15.0347V8.96533Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="icon-container hover-white" onclick="new_task(false)" style="position: absolute; right: 50px">
                    <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 7.33331V14.6666M7.33337 11H14.6667M20.1667 11C20.1667 16.0626 16.0627 20.1666 11 20.1666C5.93743 20.1666 1.83337 16.0626 1.83337 11C1.83337 5.93737 5.93743 1.83331 11 1.83331C16.0627 1.83331 20.1667 5.93737 20.1667 11Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            <div id="rn_section" class="reverse-section">

            </div>
        </div>
        </div>
        
        <div id="footer" class="footer">
            <div onclick="load_tasks()" class="footer-el hover-white">
                <svg style="top: -1px;" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2 14H14M8 2V11.3333M8 11.3333L12.6667 6.66667M8 11.3333L3.33333 6.66667" stroke="inherit" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div style="color: inherit;">
                    Загрузить ещё
                </div>
            </div>
            <div onclick="today_tasks()" class="footer-el hover-white" id="today-tasks-btn" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 6.66666H2M14 8.33333V5.86666C14 4.74656 14 4.1865 13.782 3.75868C13.5903 3.38236 13.2843 3.0764 12.908 2.88465C12.4802 2.66666 11.9201 2.66666 10.8 2.66666H5.2C4.0799 2.66666 3.51984 2.66666 3.09202 2.88465C2.71569 3.0764 2.40973 3.38236 2.21799 3.75868C2 4.1865 2 4.74656 2 5.86666V11.4667C2 12.5868 2 13.1468 2.21799 13.5746C2.40973 13.951 2.71569 14.2569 3.09202 14.4487C3.51984 14.6667 4.0799 14.6667 5.2 14.6667H8M10.6667 1.33333V3.99999M5.33333 1.33333V3.99999M9.66667 12.6667L11 14L14 11" stroke="inherit" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div style="color: inherit;">
                    Только сегодня
                </div>
            </div>
            <div onclick="user_profile_menu()" class="footer-el hover-white" style="display: none;">
                <svg width="14" height="13" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12.3333C2.55719 10.6817 4.67134 9.66667 7 9.66667C9.32866 9.66667 11.4428 10.6817 13 12.3333M10 4C10 5.65685 8.65685 7 7 7C5.34315 7 4 5.65685 4 4C4 2.34315 5.34315 1 7 1C8.65685 1 10 2.34315 10 4Z" stroke="inherit" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div id="profile-text" style="color: inherit;">
                    Профиль
                </div>
            </div>
        </div>
    </div>
    <div id="notification-container" class="notification-container">
    </div>
    <script>
        var input = document.getElementById("input")
        const stop_svg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 9.6C8 9.03995 8 8.75992 8.10899 8.54601C8.20487 8.35785 8.35785 8.20487 8.54601 8.10899C8.75992 8 9.03995 8 9.6 8H14.4C14.9601 8 15.2401 8 15.454 8.10899C15.6422 8.20487 15.7951 8.35785 15.891 8.54601C16 8.75992 16 9.03995 16 9.6V14.4C16 14.9601 16 15.2401 15.891 15.454C15.7951 15.6422 15.6422 15.7951 15.454 15.891C15.2401 16 14.9601 16 14.4 16H9.6C9.03995 16 8.75992 16 8.54601 15.891C8.35785 15.7951 8.20487 15.6422 8.10899 15.454C8 15.2401 8 14.9601 8 14.4V9.6Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`
        const start_svg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9.5 8.96533C9.5 8.48805 9.5 8.24941 9.59974 8.11618C9.68666 8.00007 9.81971 7.92744 9.96438 7.9171C10.1304 7.90525 10.3311 8.03429 10.7326 8.29239L15.4532 11.3271C15.8016 11.551 15.9758 11.663 16.0359 11.8054C16.0885 11.9298 16.0885 12.0702 16.0359 12.1946C15.9758 12.337 15.8016 12.449 15.4532 12.6729L10.7326 15.7076C10.3311 15.9657 10.1304 16.0948 9.96438 16.0829C9.81971 16.0726 9.68666 15.9999 9.59974 15.8838C9.5 15.7506 9.5 15.512 9.5 15.0347V8.96533Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`
        const new_svg = `<svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 7.33331V14.6666M7.33337 11H14.6667M20.1667 11C20.1667 16.0626 16.0627 20.1666 11 20.1666C5.93743 20.1666 1.83337 16.0626 1.83337 11C1.83337 5.93737 5.93743 1.83331 11 1.83331C16.0627 1.83331 20.1667 5.93737 20.1667 11Z" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`
        const close_svg = `<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 1L1 13M1 1L13 13" stroke="inherit" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`
        const save_svg = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M4.66667 2V4.26667C4.66667 4.64004 4.66667 4.82672 4.73933 4.96933C4.80324 5.09477 4.90523 5.19676 5.03067 5.26067C5.17328 5.33333 5.35997 5.33333 5.73333 5.33333H10.2667C10.64 5.33333 10.8267 5.33333 10.9693 5.26067C11.0948 5.19676 11.1968 5.09477 11.2607 4.96933C11.3333 4.82672 11.3333 4.64004 11.3333 4.26667V2.66667M11.3333 14V9.73333C11.3333 9.35997 11.3333 9.17328 11.2607 9.03067C11.1968 8.90523 11.0948 8.80324 10.9693 8.73933C10.8267 8.66667 10.64 8.66667 10.2667 8.66667H5.73333C5.35997 8.66667 5.17328 8.66667 5.03067 8.73933C4.90523 8.80324 4.80324 8.90523 4.73933 9.03067C4.66667 9.17328 4.66667 9.35997 4.66667 9.73333V14M14 6.21699V10.8C14 11.9201 14 12.4802 13.782 12.908C13.5903 13.2843 13.2843 13.5903 12.908 13.782C12.4802 14 11.9201 14 10.8 14H5.2C4.0799 14 3.51984 14 3.09202 13.782C2.71569 13.5903 2.40973 13.2843 2.21799 12.908C2 12.4802 2 11.9201 2 10.8V5.2C2 4.0799 2 3.51984 2.21799 3.09202C2.40973 2.71569 2.71569 2.40973 3.09202 2.21799C3.51984 2 4.0799 2 5.2 2H9.78301C10.1091 2 10.2722 2 10.4256 2.03684C10.5617 2.0695 10.6918 2.12337 10.811 2.19648C10.9456 2.27894 11.0609 2.39424 11.2915 2.62484L13.3752 4.7085C13.6058 4.9391 13.7211 5.0544 13.8035 5.18895C13.8766 5.30825 13.9305 5.43831 13.9632 5.57436C14 5.72781 14 5.89087 14 6.21699Z" stroke="black" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>`
        const trash_svg = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                           <g clip-path="url(#clip0_1_244)">
                           <g filter="url(#filter0_d_1_244)">
                           <path d="M10.6667 4V3.46667C10.6667 2.71993 10.6667 2.34656 10.5213 2.06135C10.3935 1.81047 10.1895 1.60649 9.93865 1.47866C9.65344 1.33334 9.28007 1.33334 8.53333 1.33334H7.46667C6.71993 1.33334 6.34656 1.33334 6.06135 1.47866C5.81046 1.60649 5.60649 1.81047 5.47866 2.06135C5.33333 2.34656 5.33333 2.71993 5.33333 3.46667V4M6.66667 7.66667V11M9.33333 7.66667V11M2 4H14M12.6667 4V11.4667C12.6667 12.5868 12.6667 13.1468 12.4487 13.5747C12.2569 13.951 11.951 14.2569 11.5746 14.4487C11.1468 14.6667 10.5868 14.6667 9.46667 14.6667H6.53333C5.41323 14.6667 4.85318 14.6667 4.42535 14.4487C4.04903 14.2569 3.74307 13.951 3.55132 13.5747C3.33333 13.1468 3.33333 12.5868 3.33333 11.4667V4" stroke="#inherit" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
                           </g>
                           </g>
                           <defs>
                           <filter id="filter0_d_1_244" x="-2.5" y="0.833336" width="21" height="22.3333" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                           <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                           <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                           <feOffset dy="4"/>
                           <feGaussianBlur stdDeviation="2"/>
                           <feComposite in2="hardAlpha" operator="out"/>
                           <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
                           <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1_244"/>
                           <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1_244" result="shape"/>
                           </filter>
                           <clipPath id="clip0_1_244">
                           <rect width="16" height="16" fill="white"/>
                           </clipPath>
                           </defs>
                           </svg>`
        const calendar_svg = `<svg width="14" height="15" viewBox="0 0 14 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M13 6.33333H1M9.66667 1V3.66667M4.33333 1V3.66667M4.2 14.3333H9.8C10.9201 14.3333 11.4802 14.3333 11.908 14.1153C12.2843 13.9236 12.5903 13.6176 12.782 13.2413C13 12.8135 13 12.2534 13 11.1333V5.53333C13 4.41323 13 3.85318 12.782 3.42535C12.5903 3.04903 12.2843 2.74307 11.908 2.55132C11.4802 2.33333 10.9201 2.33333 9.8 2.33333H4.2C3.0799 2.33333 2.51984 2.33333 2.09202 2.55132C1.71569 2.74307 1.40973 3.04903 1.21799 3.42535C1 3.85318 1 4.41323 1 5.53333V11.1333C1 12.2534 1 12.8135 1.21799 13.2413C1.40973 13.6176 1.71569 13.9236 2.09202 14.1153C2.51984 14.3333 3.0799 14.3333 4.2 14.3333Z" stroke="#7A7A7A" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>`
        const logout_svg = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 5.33333L14.6667 8M14.6667 8L12 10.6667M14.6667 8H6.00001M10 2.80269C9.15018 2.29218 8.16351 2 7.11112 2C3.92014 2 1.33334 4.68629 1.33334 8C1.33334 11.3137 3.92014 14 7.11112 14C8.16351 14 9.15018 13.7078 10 13.1973" stroke="inherit" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`



                            
        const container = document.getElementsByClassName("container")[0]
        let active_task = undefined

        let tasks = {}
        let offset_days = 0

        function makeid(length) {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            let counter = 0;
            while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
            }
            return result;
        }
        
        function delete_element(event, parent_recursion = 0) {
            var target = event.target
            for (let i = 0; i <= parent_recursion; i++) {
                target = target.parentNode
            }
            target.parentNode.removeChild(target)
        }

        function delete_element_by_id(id) {
            var target = document.getElementById(id)
            if (!target) {
                return
            } 
            target.parentNode.removeChild(target)
        }

        function makeid(length) {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            let counter = 0;
            while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
            }
            return result;
        }

        function clear_notification_animations() {
            let notifications = document.getElementsByClassName("show-right-animation")
            for (let i = 0; i < notifications.length; i++) {
                    notifications[i].classList.remove('show-right-animation');
            }
        }
        
        async function add_notification(text) {
            const notification_container = document.getElementById("notification-container")
            clear_notification_animations()
            const my_id = makeid(8)
            notification_container.innerHTML += `<div id="${my_id}" class="notification show-right-animation"><div>${text}</div><div class="hover-white" onclick="delete_element_by_id('${my_id}')">${close_svg}</div></div>`
            
            await new Promise(r => setTimeout(r, 1000));
            clear_notification_animations()
            }
            
        async function timer_updater() {
            while (true) {
                await new Promise(r => setTimeout(r, 300));
                if (!active_task) {
                    continue
                }

                const task_el = document.getElementById(active_task["task_id"])
                const lil_time = get_lil_time_text(active_task["started_at"], Date_now())
                const timer_text = get_timer_text(active_task["started_at"], Date_now())
                task_el.childNodes[2].textContent = lil_time
                task_el.childNodes[3].textContent = timer_text
            }
        }
        
        function stop_timer(id) {
            const timer = document.getElementById(id)
            if (timer.textContent.slice(0, 2) === "00") {
                timer.parentNode.parentNode.removeChild(timer.parentNode)
                alert("Задачи длительностью менее 1 минуты не сохраняются!")
            } else {
                timer.id = ""
                timer.textContent = timer.textContent.slice(0, 2) - 0 + " м"
            }
        }
        

        
        async function request(url, payload) {
            if (payload) {
                payload = JSON.stringify(payload)
            } else {
                payload = undefined
            }
            return await fetch(url, {
                method: "POST",
                credentials: "include",
                mode: "cors",
                body: payload,
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
        }

        function new_task_enter(event) {
            if (event.keyCode === 13) {
                new_task(false)
            }
        }
        
        
        async function new_task(is_started) {
            if (is_started && active_task !== undefined) {
                add_notification("Сначала завершите текущую задачу")
                return
            }
            const url = "/new_task"
            const input = document.getElementById("input")
            const value = input.value
            if (value === "") {
                return
            }
            const payload = {
                "text": value,
                "is_started": is_started
            }
            const response = await request(url, payload);
            const data = await response.json()
            console.log(data)
            if (data["task"]) {
                await create_task(data["task"])
            }
            input.value = ""
        }
        
        async function stop_task(task_id) {
            if (Date_now() - active_task["started_at"] - 60000 < 0) {
                add_notification("Задачи длительностью\nменее 1 минуты не сохраняюся")
                return
            }
            const url = "/stop_task"
            const payload = {
                "task_id": task_id
            }
            const response = await request(url, payload);
            const data = await response.json()
            console.log(data)
            if (data["task"]) {
                delete_element_by_id(task_id)
                active_task = undefined
                await create_task(data["task"])
            }
            input.value = ""
        }

        async function run_task(task_id) {
            if (active_task !== undefined) {
                add_notification("Сначала завершите текущую задачу")
                return
            }
            const url = "/run_task"
            const payload = {
                "task_id": task_id
            }
            const response = await request(url, payload);
            const data = await response.json()
            console.log(data)
            if (data["task"]) {
                delete_element_by_id(task_id)
                await create_task(data["task"])
            }
            input.value = ""
        }

        function to_day(time) {
            return Math.floor(time/86400000)*86400000
        }

        function get_section_by_time(time) {
            const lil_time = to_day(time)
            let section = document.getElementById(lil_time)
            console.log(section)
            if (!section) {
                let time_text = new Date(time).toLocaleString("ru", {
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short',
                    timezone: 'UTC'
                }).split(", ")
                time_text = time_text[1] + ", " + time_text[0]
                
                if (to_day(time) === to_day(Date_now())) {
                    time_text = "Сегодня"
                }
                const container = document.getElementById("container-main")
                container.innerHTML += `<div id="${lil_time}" class="section"><div class="lil-container"><div style="justify-content: normal; display: flex;" ><div class="text font-3" style="width: auto; margin-right: 13px;">${time_text}</div></div><div class="timer-text font-3"></div></div><div></div></div>`
                section = document.getElementById(lil_time)
            }
            return section.childNodes[1]
        }
        
        function get_lil_time_text(started_at, stopped_at) {
            let start_time = Math.floor((started_at - to_day(started_at)) / 60000)
            let start_minutes = (start_time % 60 + "").padStart(2, '0')
            start_time = `${Math.floor(start_time/60)}:${start_minutes}` 
            let stop_time = Math.floor((stopped_at - to_day(stopped_at)) / 60000)
            let stop_minutes = (stop_time % 60 + "").padStart(2, '0')
            stop_time = `${Math.floor(stop_time/60)}:${stop_minutes}` 
            return `${start_time} - ${stop_time}`
        }
        
        function get_timer_text(started_at, stopped_at) {
            let time = Math.floor((stopped_at - started_at) / 1000)
            let time_hours = Math.floor(time / 60 / 60)
            let time_minutes = (Math.floor(time / 60 % 60) + "").padStart(2, '0')
            let time_seconds = (time % 60 + "").padStart(2, '0')
            if (time_hours) {
                time = `${time_hours}:${time_minutes}:${time_seconds}`
            } else {
                time = `${time_minutes}:${time_seconds}`
            }
            return time
        }
        
        function get_time_text(started_at, stopped_at) {
            let time = Math.floor((stopped_at - started_at) / 60000)
            let time_hours = Math.floor(time / 60)
            if (time_hours) {
                time = `${time_hours} ч ${time % 60} м`
            } else {
                time = `${time % 60} м`
            }
            return time
        }
        
        function insertAfter(referenceNode, newNode) {
            referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
        }

        async function create_task(task) {
            const rn_section = document.getElementById("rn_section")
            const task_id = task["task_id"]
            const text = task["text"]
            const is_active = task["is_active"]
            const started_at = task["started_at"]
            const stopped_at = task["stopped_at"]
            tasks[task_id + ""] = task
            let last_el = document.getElementById(`${task_id}`)
            if (last_el) {
                last_el.parentNode.removeChild(last_el)
            }
            if (is_active) {
                active_task = task
                const hover_onmouseover = `document.getElementById('${task_id}').childNodes[3].style = 'display: none;'; document.getElementById('${task_id}').childNodes[4].style = 'display: flex;'; document.getElementById('${task_id}').childNodes[0].style = 'background-color: rgba(255, 255, 255, 0.08);'`
                const hover_onmouseout = `document.getElementById('${task_id}').childNodes[3].style = 'display: flex;'; document.getElementById('${task_id}').childNodes[4].style = 'display: none;'; document.getElementById('${task_id}').childNodes[0].style = 'background-color: rgba(255, 255, 255, 0);'`
                const lil_time = get_lil_time_text(started_at, Date_now())
                const timer_text = get_timer_text(started_at, Date_now())
                rn_section.innerHTML += `<div id="${task_id}" class="hover-container active-task" onmouseover="${hover_onmouseover}" onmouseout="${hover_onmouseout}"><div class="hover" onclick="update_task_menu('${task_id}')"></div><div class="text" onclick="update_task_menu('${task_id}')">${text}</div><div class="lil-timer" onclick="update_task_menu('${task_id}')">${lil_time}</div><div id="timer" class="timer-text">${timer_text}</div><div id="stop-button" class="center hover-white" onclick="stop_task(${task_id});" style="display: none;">${stop_svg}</div></div>`
            } else if (stopped_at) {
                let cur_section = get_section_by_time(started_at)
                const hover_onmouseover = `document.getElementById('${task_id}').childNodes[0].style = 'background-color: rgba(255, 255, 255, 0.08);'`
                const hover_onmouseout = `document.getElementById('${task_id}').childNodes[0].style = 'background-color: rgba(255, 255, 255, 0);'`
                const lil_time = get_lil_time_text(started_at, stopped_at)
                const time = get_time_text(started_at, stopped_at)
                var task_before = undefined
                cur_section.childNodes.forEach(async el => {
                    if (!task_before) {
                        let this_task = tasks[el.id + ""]
                        if (this_task["started_at"] < started_at) {
                            task_before = el
                        }
                    }
                })
                if (task_before) {
                    let tmp_el = document.createElement('div')
                    tmp_el.innerHTML = `<div id="${task_id}" class="hover-container inactive-task" onclick="update_task_full_menu('${task_id}')" onmouseover="${hover_onmouseover}" onmouseout="${hover_onmouseout}"><div class="hover"></div><div class="text">${text}</div><div class="lil-timer">${lil_time}</div><div id="timer" class="timer-text">${time}</div></div>`
                    task_before.parentNode.insertBefore(tmp_el.childNodes[0], task_before)
                } else {
                    cur_section.innerHTML += `<div id="${task_id}" class="hover-container inactive-task" onclick="update_task_full_menu('${task_id}')" onmouseover="${hover_onmouseover}" onmouseout="${hover_onmouseout}"><div class="hover"></div><div class="text">${text}</div><div class="lil-timer">${lil_time}</div><div id="timer" class="timer-text">${time}</div></div>`
                }
                update_section_time(cur_section)
            } else {
                const hover_onmouseover = `document.getElementById('${task_id}').childNodes[2].style = 'display: flex;'; document.getElementById('${task_id}').childNodes[0].style = 'background-color: rgba(255, 255, 255, 0.08);'`
                const hover_onmouseout = `document.getElementById('${task_id}').childNodes[2].style = 'display: none;'; document.getElementById('${task_id}').childNodes[0].style = 'background-color: rgba(255, 255, 255, 0);'`
                rn_section.innerHTML += `<div id="${task_id}" class="hover-container active-task" onmouseover="${hover_onmouseover}" onmouseout="${hover_onmouseout}"><div class="hover" onclick="update_task_menu('${task_id}')"></div><div class="text" onclick="update_task_menu('${task_id}')">${text}</div><div id="start-button" class="center hover-white" style="display: none;" onclick="run_task(${task_id});">${start_svg}</div></div>`
            }

        }            
        async function get_tasks() {
            const url = "/get_tasks"
            const payload = {}
            const response = await request(url, payload);
            const data = await response.json()
            console.log(data)
            data["tasks"].forEach(async task => {
                await create_task(task)
            })
        }

        async function whoami() {
            const url = "/whoami"
            const payload = {}
            const response = await request(url, payload);
            const data = await response.json()
            console.log(data)
            if (data["user"]) {
                const profile = document.getElementById("profile-text")
                profile.textContent = data["user"]["login"]
                profile.parentElement.style.display = null
            }
        }

        function Date_now() {
            return new Date(Date.now() + 60000 * 60 * 3 + 1500) - 0 
        }
        
        async function load_tasks() {
            const url = "/get_tasks"
            const payload = {
                "offset_days": offset_days,
                "length_days": 3,
            }
            offset_days += 3
            const response = await request(url, payload);
            const data = await response.json()
            console.log(data)
            data["tasks"].forEach(async task => {
                await create_task(task)
            })
            document.getElementById("today-tasks-btn").style.display = null
        }

        function today_tasks() {
            document.getElementById("today-tasks-btn").style.display = "none";
            offset_days = 0
            let sections = document.getElementsByClassName("section")
            for (let i = sections.length - 1; i >= 2; i --) {
                sections[i].parentNode.removeChild(sections[i])
            }
        }

        async function update_task(task_id) {
            const text = document.getElementById("input-centered").value
            const url = "/update_task"
            const payload = {
                "task_id": task_id - 0,
                "text": text,
            }
            const response = await request(url, payload);
            const data = await response.json()
            if (data["task"]) {
                delete_element_by_id(task_id)
                await create_task(data["task"])
            }
        }

        async function update_task_full(task_id) {
            const text = document.getElementById("input-centered").value
            const url = "/update_task"
            const task = tasks[task_id + ""]
            let time_first = document.getElementById("input-time-first").value.split(":")
            time_first = ((time_first[0] - 0) * 60 + (time_first[1] - 0)) * 60000
            let time_second = document.getElementById("input-time-second").value.split(":")
            time_second = ((time_second[0] - 0) * 60 + (time_second[1] - 0)) * 60000
            if (time_first > time_second) {
                time_second += 60000 * 24 * 60
            }
            let started_at = to_day(task["started_at"]) + time_first
            let stopped_at = to_day(task["started_at"]) + time_second
            if (started_at - stopped_at == 0) {
                add_notification(("Задачи длительностью\nменее 1 минуты не сохраняюся"))
                return
            }
            const payload = {
                "task_id": task_id - 0,
                "text": text,
                "started_at": started_at,
                "stopped_at": stopped_at,
            }
            const response = await request(url, payload);
            const data = await response.json()
            if (data["task"]) {
                delete_element_by_id(task_id)
                await create_task(data["task"])
            }
        }

        async function delete_task(task_id) {
            const url = "/delete_task"
            const payload = {
                "task_id": task_id,
            }
            const response = await request(url, payload);
            const data = await response.json()
            if (data["success"]) {
                if (active_task && active_task["task_id"] == task_id) {
                    active_task = undefined
                }
                delete_element_by_id(task_id)
            }
            
            let cur_section = get_section_by_time(tasks[task_id + ""]["started_at"])
            update_section_time(cur_section)
        }
        
        function update_task_menu(task_id) {
            const body = document.body
            const my_id = makeid(8)
            const text = document.getElementById(task_id).childNodes[1].textContent
            body.innerHTML += `<div id="${my_id}" class="bg">
                <div class="centered-window">
                    <div class="row">
                        <div>Редактирование задачи</div>
                        <div class="hover-white" onclick="delete_element_by_id('${my_id}')">${close_svg}</div>
                    </div>
                    <div class="row">
                        <input id="input-centered" class="gray input font-1" value="${text}">
                    </div>
                    <div class="row">
                        <div onclick="update_task('${task_id}'); delete_element_by_id('${my_id}')" class="white btn hover-white" style="width: 106px">${save_svg}<div style="color: #000000;">Сохранить</div></div>
                        <div onclick="delete_task('${task_id}'); delete_element_by_id('${my_id}')" class="black btn hover-black" style="width: 106px">${trash_svg}<div style="color: inherit;">Удалить</div></div>
                    </div>
                </div>
            </div>`
        }
        
        function recount_time_text() {
            let lil_timer = [
                document.getElementById("input-time-first").value,
                document.getElementById("input-time-second").value,
            ]
            let start_time = ((lil_timer[0].split(":")[0] - 0) * 60 + (lil_timer[0].split(":")[1] - 0)) * 60000
            let stop_time = ((lil_timer[1].split(":")[0] - 0) * 60 + (lil_timer[1].split(":")[1] - 0)) * 60000
            if (stop_time < start_time) {
                stop_time += 24 * 60  * 60000
            }
            console.log(lil_timer, start_time, stop_time)
            const time_text = get_time_text(start_time, stop_time)
            document.getElementById("input-time-text").textContent = time_text
        }
        
        function update_task_full_menu(task_id) {
            const body = document.body
            const my_id = makeid(8)
            const text = document.getElementById(task_id).childNodes[1].textContent
            const task = tasks[task_id + ""]
            const day_start_text = new Date(task["started_at"]).toLocaleString("ru", {
                    month: 'long',
                    day: 'numeric',
                    timezone: 'UTC'
                }) 
            const lil_timer = get_lil_time_text(task["started_at"], task["stopped_at"]).split(" - ")
            const time_text = get_time_text(task["started_at"], task["stopped_at"])
            body.innerHTML += `<div id="${my_id}" class="bg">
                <div class="centered-window">
                    <div class="row">
                        <div>Редактирование задачи</div>
                        <div class="hover-white" onclick="delete_element_by_id('${my_id}')">${close_svg}</div>
                    </div>
                    <div class="row">
                        <input id="input-centered" class="gray input font-1" value="${text}">
                    </div>
                    <div class="row" style="justify-content: flex-start;">
                        <input id="input-time-first" onchange="recount_time_text()" class="gray input font-2" style="width: 50px; padding: 10px; text-align: center;" value="${lil_timer[0]}">
                        <div class="center font-2" style="width: 20px; justify-content: center;">-</div>
                        <input id="input-time-second" onchange="recount_time_text()" class="gray input font-2" style="width: 50px; padding: 10px; text-align: center;" value="${lil_timer[1]}">
                        <div id="input-time-text" class="center timer-text" style="width: 120px; justify-content: right;">${time_text}</div>
                    </div>
                    <div class="row" style="justify-content: flex-start; gap: 2px;">
                        <div>${calendar_svg}</div>
                        <div style="color: rgba(122, 122, 122, 1); display: flex; align-items: center;">${day_start_text}</div>
                    </div>
                    <div class="row">
                        <div onclick="update_task_full('${task_id}'); delete_element_by_id('${my_id}')" class="white btn hover-white" style="width: 106px">${save_svg}<div style="color: #000000;">Сохранить</div></div>
                        <div onclick="delete_task('${task_id}'); delete_element_by_id('${my_id}')" class="black btn hover-black" style="width: 106px">${trash_svg}<div style="color: inherit;">Удалить</div></div>
                    </div>
                </div>
            </div>`
        }
        
        async function new_task_full() {
            const text = document.getElementById("input-centered").value
            const url = "/new_task"
            let time_first = document.getElementById("input-time-first").value.split(":")
            time_first = ((time_first[0] - 0) * 60 + (time_first[1] - 0)) * 60000
            let time_second = document.getElementById("input-time-second").value.split(":")
            time_second = ((time_second[0] - 0) * 60 + (time_second[1] - 0)) * 60000
            if (time_first > time_second) {
                time_second += 60000 * 24 * 60
            }
            let started_at = to_day(Date_now()) + time_first
            let stopped_at = to_day(Date_now()) + time_second
            if (started_at - stopped_at == 0) {
                add_notification(("Задачи длительностью\nменее 1 минуты не сохраняюся"))
                return
            }
            const payload = {
                "text": text,
                "started_at": started_at,
                "stopped_at": stopped_at,
            }
            const response = await request(url, payload);
            const data = await response.json()
            if (data["task"]) {
                await create_task(data["task"])
            }
        }

        async function user_profile_update() {
            const login = document.getElementById("input-login").value
            const password = document.getElementById("input-password").value
            const url = "/update_user"
            const payload = {
                "login": login,
                "password": password,
            }
            const response = await request(url, payload);
            const data = await response.json()
            if (data["success"]) {
                const profile = document.getElementById("profile-text")
                profile.textContent = login
            }
        }
        
        function user_profile_menu() {
            const body = document.body
            const my_id = makeid(8)
            const login = document.getElementById("profile-text").textContent
            body.innerHTML += `<div id="${my_id}" class="bg">
                <div class="centered-window">
                    <div class="row">
                        <div>Редактирование задачи</div>
                        <div class="hover-white" onclick="delete_element_by_id('${my_id}')">${close_svg}</div>
                    </div>
                    <div class="row">
                        <input id="input-login" class="gray input font-1" value="${login}">
                    </div>
                    <div class="row" style="justify-content: flex-start;">
                        <input id="input-password" placeholder="********" class="gray input font-1">
                    </div>
                    <div class="row">
                        <div onclick="user_profile_update(); delete_element_by_id('${my_id}')" class="white btn hover-white" style="width: 106px">${save_svg}<div style="color: #000000;">Сохранить</div></div>
                        <div onclick="window.location.replace('/logout');" class="black btn hover-black" style="width: 106px">${logout_svg}<div style="color: inherit;">Выйти</div></div>
                    </div>
                </div>
            </div>`
        }
        
        function new_task_full_menu() {
            const body = document.body
            const my_id = makeid(8)
            const text = ""
            const day_start_text = new Date(to_day(Date_now())).toLocaleString("ru", {
                    month: 'long',
                    day: 'numeric',
                    timezone: 'UTC'
                }) 
            const lil_timer = ["0:00", "0:10"]
            const time_text = "10 м"
            body.innerHTML += `<div id="${my_id}" class="bg">
                <div class="centered-window">
                    <div class="row">
                        <div>Добавление новой задачи</div>
                        <div class="hover-white" onclick="delete_element_by_id('${my_id}')">${close_svg}</div>
                    </div>
                    <div class="row">
                        <input id="input-centered" class="gray input font-1" value="${text}">
                    </div>
                    <div class="row" style="justify-content: flex-start;">
                        <input id="input-time-first" onchange="recount_time_text()" class="gray input font-2" style="width: 50px; padding: 10px; text-align: center;" value="${lil_timer[0]}">
                        <div class="center font-2" style="width: 20px; justify-content: center;">-</div>
                        <input id="input-time-second" onchange="recount_time_text()" class="gray input font-2" style="width: 50px; padding: 10px; text-align: center;" value="${lil_timer[1]}">
                        <div id="input-time-text" class="center timer-text" style="width: 120px; justify-content: right;">${time_text}</div>
                    </div>
                    <div class="row" style="justify-content: flex-start; gap: 2px;">
                        <div>${calendar_svg}</div>
                        <div style="color: rgba(122, 122, 122, 1); display: flex; align-items: center;">${day_start_text}</div>
                    </div>
                    <div class="row">
                        <div onclick="new_task_full(); delete_element_by_id('${my_id}')" class="white btn hover-white" style="width: 106px">${save_svg}<div style="color: #000000;">Сохранить</div></div>
                    </div>
                </div>
            </div>`
        }
        
        function update_section_time(section) {
            let minutes = 0
            console.log("section.childNodes:", section.childNodes)
            section.childNodes.forEach(el => {
                let temp = el.childNodes[3].textContent
                temp = temp.split(" ч ")
                if (temp.length === 2) {
                    minutes += (temp[0] - 0) * 60
                    temp = temp[1]
                } else {
                    temp = temp[0]
                }
                temp = temp.split(" м")                
                minutes += temp[0] - 0
            })

            let text = `${minutes} м`
            if (minutes >= 60) {
                text = `${Math.floor(minutes / 60)} ч ${minutes % 60} м`
            }
            
            section.parentNode.childNodes[0].childNodes[1].textContent = text

        }
        
        whoami()
        get_tasks()
        let today_section = get_section_by_time(Date_now())
        today_section.parentNode.childNodes[0].childNodes[0].innerHTML += `<div class="center hover-white" onclick="new_task_full_menu()">${new_svg}</div>`
        update_section_time(today_section)
        timer_updater()
    </script>
</body>
</html>